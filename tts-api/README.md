# NeuTTS Air TTS API

Production-ready FastAPI wrapper for [NeuTTS Air](https://github.com/neuphonic/neutts-air) - the world's first super-realistic, on-device TTS with instant voice cloning.

## ğŸ¯ Purpose

This API wraps the official NeuTTS Air model into a clean HTTP API that can be:
- Deployed to Railway
- Called from Bolt.new frontend
- Reused across multiple projects
- Run on CPU-only infrastructure

## âš–ï¸ Legal Compliance

**CRITICAL - READ CAREFULLY:**

âœ… **ALLOWED:**
- Style-based generic voices (e.g., "deep male", "calm female")
- Users uploading their OWN voice for cloning
- Reference audio used temporarily (not stored)
- AI-generated disclosure (automatic watermarking)

âŒ **PROHIBITED:**
- Celebrity voice cloning
- Using voices without permission
- Permanent training on uploaded voices
- YouTube audio usage
- Misrepresenting AI audio as human

All audio generated by this API is watermarked using Perth (Perceptual Threshold).

## ğŸš€ Quick Start (Windows + VS Code)

### Prerequisites

1. **Install espeak-ng** (required for phonemizer):
   ```powershell
   # Option 1: Using winget (recommended)
   winget install -e --id eSpeak-NG.eSpeak-NG
   
   # Option 2: Using Chocolatey
   choco install espeak-ng
   
   # Option 3: Download MSI from
   # https://github.com/espeak-ng/espeak-ng/releases
   ```

2. **Set environment variables** (if installed via MSI):
   ```powershell
   $env:PHONEMIZER_ESPEAK_LIBRARY = "c:\Program Files\eSpeak NG\libespeak-ng.dll"
   $env:PHONEMIZER_ESPEAK_PATH = "c:\Program Files\eSpeak NG"
   setx PHONEMIZER_ESPEAK_LIBRARY "c:\Program Files\eSpeak NG\libespeak-ng.dll"
   setx PHONEMIZER_ESPEAK_PATH "c:\Program Files\eSpeak NG"
   ```

### Setup

1. **Open VS Code terminal** (Ctrl+`)

2. **Navigate to directory:**
   ```bash
   cd tts-api
   ```

3. **Create virtual environment:**
   ```bash
   python -m venv venv
   .\venv\Scripts\activate
   ```

4. **Install dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

5. **Verify NeuTTS Air is cloned:**
   ```bash
   dir neutts-air
   ```
   If not present, clone it:
   ```bash
   git clone https://github.com/neuphonic/neutts-air.git
   ```

6. **Set environment variables:**
   Create `.env` file:
   ```
   API_KEY=your-secure-api-key-here
   PORT=8080
   BACKBONE_REPO=neuphonic/neutts-air
   CODEC_REPO=neuphonic/neucodec
   ```

7. **Run the API:**
   ```bash
   python app.py
   ```

API will be available at: `http://localhost:8080`

## ğŸ“¡ API Endpoints

### Health Check
```bash
GET http://localhost:8080/
GET http://localhost:8080/health
```

Response:
```json
{
  "status": "healthy",
  "model_loaded": true,
  "backbone": "neuphonic/neutts-air",
  "voice_cloning_support": true,
  "watermarked": true
}
```

### Generate Speech
```bash
POST http://localhost:8080/tts
Headers:
  x-api-key: your-secure-api-key-here
  Content-Type: application/json

Body:
{
  "text": "Your text here",
  "voice_url": "https://example.com/voice.wav",  // optional
  "ref_text": "Transcript of reference audio"    // optional
}

Response:
  WAV audio file (24kHz, watermarked)
```

## ğŸ§ª Testing Locally

### Test with PowerShell:
```powershell
# Health check
curl.exe http://localhost:8080/health

# Generate speech with default voice
curl.exe -X POST http://localhost:8080/tts `
  -H "x-api-key: your-api-key" `
  -H "Content-Type: application/json" `
  -d '{\"text\": \"Never give up on your dreams\"}' `
  --output speech.wav

# Generate speech with voice cloning
curl.exe -X POST http://localhost:8080/tts `
  -H "x-api-key: your-api-key" `
  -H "Content-Type: application/json" `
  -d '{\"text\": \"Hello world\", \"voice_url\": \"https://example.com/my-voice.wav\", \"ref_text\": \"Sample text\"}' `
  --output cloned.wav
```

### Test with Python:
```python
import requests

# Generate speech
response = requests.post(
    "http://localhost:8080/tts",
    headers={
        "x-api-key": "your-api-key",
        "Content-Type": "application/json"
    },
    json={
        "text": "This is a test of NeuTTS Air voice cloning",
        "voice_url": "https://example.com/reference.wav",
        "ref_text": "Reference audio transcript"
    }
)

# Save audio
with open("output.wav", "wb") as f:
    f.write(response.content)
```

## ğŸš‚ Railway Deployment

### Method 1: Deploy from GitHub

1. **Push to GitHub:**
   ```bash
   cd tts-api
   git init
   git add .
   git commit -m "NeuTTS Air TTS API"
   git remote add origin https://github.com/yourusername/neutts-air-api.git
   git push -u origin main
   ```

2. **Deploy on Railway:**
   - Go to [railway.app](https://railway.app)
   - Click "New Project"
   - Select "Deploy from GitHub repo"
   - Choose your repository
   - Railway auto-detects Dockerfile

3. **Set Environment Variables:**
   In Railway dashboard â†’ Variables:
   ```
   API_KEY=your-secure-random-key-here
   BACKBONE_REPO=neuphonic/neutts-air
   CODEC_REPO=neuphonic/neucodec
   ```
   (PORT is set automatically by Railway)

4. **Wait for Deployment:**
   - First deployment takes ~5-10 minutes (downloading models)
   - Check logs for "âœ… NeuTTS Air model loaded successfully"

5. **Get Your API URL:**
   - Railway provides: `https://your-service.railway.app`
   - Test: `https://your-service.railway.app/health`

### Method 2: Railway CLI

```bash
# Install Railway CLI
npm i -g @railway/cli

# Login
railway login

# Initialize project
railway init

# Deploy
railway up

# Set environment variables
railway variables set API_KEY=your-secure-key
railway variables set BACKBONE_REPO=neuphonic/neutts-air
railway variables set CODEC_REPO=neuphonic/neucodec
```

## ğŸ”— Integration with Bolt.new

In your Bolt.new backend, call the API:

```javascript
// backend/server.js
async function generateSpeech(text, voiceUrl = null, refText = null) {
  const response = await fetch('https://your-service.railway.app/tts', {
    method: 'POST',
    headers: {
      'x-api-key': process.env.TTS_API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      text: text,
      voice_url: voiceUrl,
      ref_text: refText
    })
  });

  if (!response.ok) {
    throw new Error(`TTS API error: ${response.statusText}`);
  }

  const audioBuffer = await response.arrayBuffer();
  return audioBuffer;
}

// Usage
app.post('/api/generate-audio', async (req, res) => {
  try {
    const { text, voiceUrl, refText } = req.body;
    const audio = await generateSpeech(text, voiceUrl, refText);
    
    res.set('Content-Type', 'audio/wav');
    res.send(Buffer.from(audio));
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

## ğŸ“ Project Structure

```
tts-api/
â”œâ”€â”€ neutts-air/          # Cloned NeuTTS Air repository
â”‚   â”œâ”€â”€ neuttsair/       # Core NeuTTS Air code
â”‚   â”œâ”€â”€ samples/         # Sample reference voices
â”‚   â””â”€â”€ requirements.txt # NeuTTS Air dependencies
â”œâ”€â”€ app.py              # FastAPI application
â”œâ”€â”€ requirements.txt    # All dependencies
â”œâ”€â”€ Dockerfile         # Railway deployment config
â”œâ”€â”€ README.md          # This file
â””â”€â”€ .env               # Environment variables (create this)
```

## ğŸ”§ How It Works

1. **Startup:**
   - NeuTTS Air model loads once at server startup
   - Model stays in memory for fast inference
   - Uses CPU-only mode (Railway compatible)

2. **Request Flow:**
   ```
   Client â†’ POST /tts â†’ Validate API key
                      â†’ Download reference audio (if provided)
                      â†’ Encode reference with NeuTTS Air
                      â†’ Generate speech with NeuTTS Air
                      â†’ Return WAV file (watermarked)
                      â†’ Cleanup temp files
   ```

3. **Voice Cloning:**
   - Reference audio downloaded temporarily
   - Encoded into voice codes
   - Used for inference
   - Deleted immediately after
   - No permanent storage

## ğŸ› Troubleshooting

### espeak-ng not found
```powershell
# Verify installation
where.exe espeak-ng

# If not found, reinstall and add to PATH
winget install -e --id eSpeak-NG.eSpeak-NG

# Set environment variables
$env:PHONEMIZER_ESPEAK_LIBRARY = "c:\Program Files\eSpeak NG\libespeak-ng.dll"
$env:PHONEMIZER_ESPEAK_PATH = "c:\Program Files\eSpeak NG"
```

### Model loading fails
- Check internet connection (models download from HuggingFace)
- Verify Python version is 3.9
- Check logs for specific error
- Try clearing HuggingFace cache: `rm -rf ~/.cache/huggingface`

### Railway deployment issues
- Check Railway logs for errors
- Verify environment variables are set
- Ensure Dockerfile is in root directory
- First deployment takes longer (model download)

### Port already in use
```bash
# Windows: Find and kill process
netstat -ano | findstr :8080
taskkill /PID <PID> /F
```

## ğŸ“Š Performance

- **Cold start:** ~30-60 seconds (model loading)
- **Warm inference:** ~2-5 seconds per request
- **CPU usage:** Moderate (optimized for CPU)
- **Memory:** ~2-4 GB (model in memory)
- **Audio quality:** 24kHz, watermarked

## ğŸ” Security

- API key authentication required
- Input validation (max 10000 chars)
- Temporary file cleanup
- No data persistence
- HTTPS on Railway
- Watermarked outputs

## ğŸ“ Environment Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| API_KEY | Yes | - | API authentication key |
| PORT | No | 8080 | Server port (Railway sets this) |
| BACKBONE_REPO | No | neuphonic/neutts-air | HuggingFace model repo |
| CODEC_REPO | No | neuphonic/neucodec | HuggingFace codec repo |

## ğŸ“ Usage Examples

### Motivational Speech
```bash
curl.exe -X POST https://your-service.railway.app/tts \
  -H "x-api-key: your-key" \
  -H "Content-Type: application/json" \
  -d '{\"text\": \"You have the power to achieve anything you set your mind to. Never give up on your dreams! Every challenge is an opportunity to grow stronger.\"}' \
  --output motivational.wav
```

### Voice Cloning
```bash
curl.exe -X POST https://your-service.railway.app/tts \
  -H "x-api-key: your-key" \
  -H "Content-Type: application/json" \
  -d '{\"text\": \"Hello, this is my cloned voice\", \"voice_url\": \"https://example.com/my-voice.wav\", \"ref_text\": \"Sample reference text\"}' \
  --output cloned.wav
```

## âœ… Production Checklist

- [ ] espeak-ng installed and configured
- [ ] NeuTTS Air cloned in tts-api directory
- [ ] Virtual environment created
- [ ] Dependencies installed
- [ ] Strong API_KEY set
- [ ] Tested locally
- [ ] Pushed to GitHub
- [ ] Deployed to Railway
- [ ] Environment variables set on Railway
- [ ] Health endpoint returns 200
- [ ] Test TTS generation works
- [ ] Integrated with Bolt.new
- [ ] Legal compliance verified

## ğŸ“ Support

For issues:
1. Check Railway logs
2. Verify espeak-ng installation
3. Test locally first
4. Check NeuTTS Air GitHub issues
5. Verify API key is correct

## ğŸ”— Links

- NeuTTS Air: https://github.com/neuphonic/neutts-air
- HuggingFace Model: https://huggingface.co/neuphonic/neutts-air
- Railway: https://railway.app
- Neuphonic: https://neuphonic.com

---

**Ready to deploy!** This API uses the real NeuTTS Air model and is production-ready for Railway.
